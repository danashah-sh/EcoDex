<!DOCTYPE html>
<html lang="no">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>EcoDex 2.0</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="https://unpkg.com/ml5@1.2.0/dist/ml5.min.js"></script>

    <style>
        :root {
            --primary: #27ae60;
            --bg-color: #f0f2f5;
            --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --chat-me: #2ecc71;
            --chat-them: #e5e5ea;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { margin: 0; background: var(--bg-color); font-family: var(--font); overflow: hidden; height: 100vh; height: 100dvh; }

        /* GENERELT UI */
        .btn { background: var(--primary); color: white; border: none; padding: 15px; border-radius: 10px; font-weight: bold; font-size: 16px; width: 100%; cursor: pointer; }
        .btn:active { transform: scale(0.98); }
        .hidden { display: none !important; }
        
        /* LOGIN */
        #loginScreen {
            position: fixed; inset: 0; background: radial-gradient(circle, #2ecc71, #27ae60);
            z-index: 10000; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 30px;
        }
        .login-box { background: white; padding: 30px; border-radius: 20px; width: 100%; max-width: 350px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .login-input { width: 100%; padding: 15px; margin: 10px 0; border: 2px solid #eee; border-radius: 10px; font-size: 16px; text-align: center; }

        /* KART */
        #map { position: absolute; inset: 0; z-index: 1; }
        .player-icon { font-size: 40px; text-align: center; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.4)); animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        /* HUD */
        .top-hud { position: absolute; top: 0; left: 0; right: 0; padding: 15px; z-index: 1000; display: flex; flex-direction: column; align-items: center; pointer-events: none; }
        .hud-bg { background: rgba(255,255,255,0.95); padding: 8px 20px; border-radius: 30px; display: flex; gap: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        #debug { font-size: 10px; background: rgba(0,0,0,0.5); color: white; padding: 2px 5px; border-radius: 5px; margin-top: 5px; max-width: 90%; text-align: center; }

        /* KAMERA */
        #cameraPage { position: fixed; inset: 0; background: black; z-index: 6000; display: none; }
        #cameraPage.active { display: block; }
        #videoFeed { width: 100%; height: 100%; object-fit: cover; }
        #canvas { display: none; } /* Skjult canvas for AI-analyse */
        #capturedPhoto { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; display: none; z-index: 6001; }
        
        .camera-ui { position: absolute; bottom: 50px; width: 100%; display: flex; flex-direction: column; align-items: center; gap: 20px; z-index: 6005; }
        .snap-btn { width: 80px; height: 80px; background: white; border-radius: 50%; border: 6px solid #ddd; cursor: pointer; }
        #aiResultText { color: white; font-weight: bold; background: rgba(0,0,0,0.7); padding: 15px; border-radius: 20px; font-size: 18px; text-align: center; display: none; max-width: 80%; }
        .close-cam { position: absolute; top: 30px; right: 20px; color: white; font-size: 35px; z-index: 7000; cursor: pointer; text-shadow: 0 0 5px black; }

        /* MENY */
        .bottom-nav {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; height: 65px; background: white; border-radius: 35px;
            display: flex; justify-content: space-around; align-items: center; z-index: 4500;
            box-shadow: 0 5px 25px rgba(0,0,0,0.2);
        }
        .nav-item { font-size: 24px; cursor: pointer; opacity: 0.5; }
        .nav-item.active { opacity: 1; color: var(--primary); }
        .cam-btn { 
            width: 60px; height: 60px; background: var(--primary); border-radius: 50%; 
            display: flex; justify-content: center; align-items: center; color: white; font-size: 30px;
            margin-bottom: 30px; border: 4px solid white; box-shadow: 0 -5px 10px rgba(0,0,0,0.1);
        }

        /* SIDER (Butikk/Profil etc) */
        .page { position: fixed; inset: 0; background: #f0f2f5; z-index: 4000; display: none; padding: 20px; flex-direction: column; overflow-y: auto; padding-bottom: 100px;}
        .page.active { display: flex; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .card { background: white; padding: 15px; border-radius: 15px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

    </style>
</head>

<body>

    <div id="loginScreen">
        <h1 style="margin:0; font-size:40px;">ECODEX</h1>
        <p>Utforsk naturen med AI</p>
        <div class="login-box">
            <input type="text" id="username" class="login-input" placeholder="Ditt navn">
            <button class="btn" onclick="startGame()">START SPILLET</button>
        </div>
        <div id="loginStatus" style="margin-top:20px; font-size:12px;">Klargj√∏r systemer...</div>
    </div>

    <div class="top-hud">
        <div class="hud-bg">
            <div style="font-weight:900; color:var(--primary);">ECODEX</div>
            <div>‚≠ê <span id="scoreDisplay">0</span></div>
        </div>
        <div id="debug">Venter p√• kamera/GPS...</div>
    </div>

    <div id="map"></div>

    <div id="cameraPage">
        <div class="close-cam" onclick="closeCamera()">‚úï</div>
        <video id="videoFeed" autoplay playsinline muted></video>
        <canvas id="canvas"></canvas>
        <img id="capturedPhoto" src="">
        
        <div class="camera-ui">
            <div id="aiResultText">Laster AI...</div>
            <button id="snapBtn" class="snap-btn" onclick="takePhoto()"></button>
            <button id="saveBtn" class="btn hidden" onclick="savePhoto()">LAGRE (+POENG)</button>
        </div>
    </div>

    <div id="profilePage" class="page">
        <h2>Min Profil</h2>
        <div class="card">
            <h1 id="profileName">Navn</h1>
            <p>Poeng: <span id="profileScore">0</span></p>
        </div>
        <h3>Mine Bilder</h3>
        <div id="gallery" class="grid"></div>
        <button class="btn" style="margin-top:20px; background:#e74c3c;" onclick="location.reload()">Logg ut</button>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="showMap()">üó∫Ô∏è</div>
        <div class="cam-btn" onclick="openCamera()">üì∑</div>
        <div class="nav-item" onclick="showProfile()">üë§</div>
    </div>

    <script>
        // --- KONFIGURASJON ---
        let state = { username: "Gjest", score: 0, photos: [] };
        let map, playerMarker, classifier;
        let aiReady = false;

        // --- OPPSTART ---
        window.onload = function() {
            // Last inn lagret data
            const saved = localStorage.getItem('ecoDexSimple');
            if (saved) state = JSON.parse(saved);
            
            // Last inn AI-modellen
            log("Laster AI-modell (MobileNet)...");
            classifier = ml5.imageClassifier('MobileNet', () => {
                aiReady = true;
                log("AI er KLAR! üß†");
                document.getElementById('loginStatus').innerText = "AI er klar. Skriv navn for √• starte.";
                document.getElementById('loginStatus').style.color = "green";
            });
        };

        function log(msg) {
            console.log(msg);
            document.getElementById('debug').innerText = msg;
        }

        function startGame() {
            const name = document.getElementById('username').value;
            if(name) state.username = name;
            document.getElementById('loginScreen').style.display = 'none';
            initMap();
            updateUI();
        }

        // --- KART ---
        function initMap() {
            if(map) return;
            map = L.map('map', { zoomControl: false }).setView([59.91, 10.75], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
            
            // Hent posisjon
            if(navigator.geolocation) {
                navigator.geolocation.watchPosition(pos => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    const latlng = [lat, lng];
                    
                    if(!playerMarker) {
                        playerMarker = L.marker(latlng).addTo(map).bindPopup("Meg");
                        map.setView(latlng, 16);
                    } else {
                        playerMarker.setLatLng(latlng);
                    }
                    log("GPS Oppdatert ‚úÖ");
                }, err => {
                    log("GPS Feil: " + err.message);
                    alert("Tillat GPS for √• bruke kartet.");
                }, { enableHighAccuracy: true });
            }
        }

        // --- KAMERA & AI (VIKTIG DEL!) ---
        async function openCamera() {
            document.getElementById('cameraPage').classList.add('active');
            
            // Nullstill UI
            document.getElementById('snapBtn').style.display = 'block';
            document.getElementById('saveBtn').classList.add('hidden');
            document.getElementById('capturedPhoto').style.display = 'none';
            document.getElementById('aiResultText').style.display = 'none';
            document.getElementById('videoFeed').style.display = 'block';

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment', width: {ideal: 1280}, height: {ideal: 720} } 
                });
                document.getElementById('videoFeed').srcObject = stream;
                log("Kamera startet üì∑");
            } catch (err) {
                alert("Kunne ikke starte kamera. Sjekk at du bruker HTTPS eller localhost, og har gitt tillatelse.");
                log("Cam error: " + err);
            }
        }

        function closeCamera() {
            const vid = document.getElementById('videoFeed');
            if(vid.srcObject) {
                vid.srcObject.getTracks().forEach(t => t.stop());
            }
            document.getElementById('cameraPage').classList.remove('active');
        }

        function takePhoto() {
            if (!aiReady) {
                alert("Vent litt, AI-hjernen laster fortsatt...");
                return;
            }

            const video = document.getElementById('videoFeed');
            const canvas = document.getElementById('canvas');
            const photo = document.getElementById('capturedPhoto');
            const uiText = document.getElementById('aiResultText');

            // 1. Tegn video til canvas (ta bildet)
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);

            // 2. Vis bildet og skjul video
            photo.src = canvas.toDataURL('image/jpeg');
            photo.style.display = 'block';
            video.style.display = 'none';
            document.getElementById('snapBtn').style.display = 'none';

            // 3. Start Analyse
            uiText.innerText = "üîç Analyserer...";
            uiText.style.display = 'block';

            // 4. KJ√òR AI P√Ö CANVAS DIREKTE (Raskere!)
            classifier.classify(canvas, (error, results) => {
                if (error) {
                    console.error(error);
                    uiText.innerText = "‚ùå Feil: " + error;
                    // Fallback hvis AI feiler helt
                    setupSaveButton("Ukjent", 10);
                } else {
                    console.log(results); // Vis i konsoll
                    behandleResultat(results);
                }
            });
        }

        function behandleResultat(results) {
            const label = results[0].label.toLowerCase();
            const confidence = Math.floor(results[0].confidence * 100);
            
            let norskNavn = "Noe spennende";
            let poeng = 10;
            let erNatur = false;

            // Enkel oversettelse
            if (label.includes('bird') || label.includes('eagle')) { norskNavn = "Fugl"; poeng = 100; erNatur = true; }
            else if (label.includes('dog') || label.includes('terrier')) { norskNavn = "Hund"; poeng = 50; erNatur = true; }
            else if (label.includes('cat')) { norskNavn = "Katt"; poeng = 50; erNatur = true; }
            else if (label.includes('flower') || label.includes('daisy') || label.includes('rose')) { norskNavn = "Blomst"; poeng = 80; erNatur = true; }
            else if (label.includes('tree')) { norskNavn = "Tre"; poeng = 60; erNatur = true; }
            else if (label.includes('grass')) { norskNavn = "Gress"; poeng = 20; erNatur = true; }
            else if (label.includes('water') || label.includes('sea') || label.includes('lakeside')) { norskNavn = "Vann"; poeng = 50; erNatur = true; }
            else {
                // Hvis den ser tastatur, sko, flaske osv.
                norskNavn = "Ukjent objekt (" + label + ")";
            }

            const tekst = `Jeg er ${confidence}% sikker p√• at dette er: ${norskNavn}`;
            document.getElementById('aiResultText').innerText = tekst;
            
            setupSaveButton(norskNavn, poeng);
        }

        function setupSaveButton(navn, poeng) {
            const btn = document.getElementById('saveBtn');
            btn.innerText = `LAGRE (+${poeng} p)`;
            btn.onclick = () => {
                state.score += poeng;
                state.photos.push({ 
                    img: document.getElementById('capturedPhoto').src, 
                    navn: navn, 
                    poeng: poeng 
                });
                saveData();
                updateUI();
                closeCamera();
                showProfile(); // G√• til profil for √• se bildet
            };
            btn.classList.remove('hidden');
        }

        // --- UI & DATA ---
        function showMap() { hideAll(); document.getElementById('map').style.display = 'block'; }
        function showProfile() { 
            hideAll(); 
            document.getElementById('profilePage').classList.add('active'); 
            renderGallery();
        }
        function hideAll() {
            document.getElementById('profilePage').classList.remove('active');
            document.getElementById('map').style.display = 'none';
        }

        function updateUI() {
            document.getElementById('scoreDisplay').innerText = state.score;
            document.getElementById('profileScore').innerText = state.score;
            document.getElementById('profileName').innerText = state.username;
        }

        function renderGallery() {
            const div = document.getElementById('gallery');
            div.innerHTML = "";
            [...state.photos].reverse().forEach(p => {
                div.innerHTML += `
                    <div class="card" style="padding:0; overflow:hidden;">
                        <img src="${p.img}" style="width:100%; height:120px; object-fit:cover;">
                        <div style="padding:10px;"><b>${p.navn}</b><br>${p.poeng} poeng</div>
                    </div>`;
            });
        }

        function saveData() {
            localStorage.setItem('ecoDexSimple', JSON.stringify(state));
        }

    </script>
</body>
</html>