<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>EcoDex</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* --- DESIGN TILPASSET DINE BILDER --- */
        :root { 
            --primary: #2ecc71;      /* Den gr√∏nne fargen fra bildet */
            --primary-dark: #27ae60;
            --bg-color: #f0f2f5;
            --text-color: #333;
            --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { margin: 0; background: var(--bg-color); font-family: var(--font); overflow: hidden; height: 100vh; height: 100dvh; }

        /* START SKJERM */
        #startScreen {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: white; z-index: 99999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; padding: 20px;
        }
        .start-btn {
            background: var(--primary); color: white; padding: 20px 60px;
            border-radius: 50px; border: none; font-size: 20px; font-weight: 800;
            margin-top: 30px; box-shadow: 0 10px 25px rgba(46, 204, 113, 0.4);
            cursor: pointer; animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.05);} 100% {transform: scale(1);} }

        /* KART */
        #map { position: absolute; top: 0; bottom: 0; left: 0; right: 0; z-index: 1; }
        
        /* HUD (Kart overlay) */
        .top-hud {
            position: absolute; top: 0; left: 0; right: 0; 
            padding: 15px 20px; padding-top: max(15px, env(safe-area-inset-top));
            z-index: 1000; display: flex; flex-direction: column; align-items: center;
            pointer-events: none;
        }
        .hud-bg { 
            background: rgba(255,255,255,0.9); padding: 8px 20px; border-radius: 30px; 
            display: flex; gap: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .logo { font-weight: 900; color: var(--primary); }
        .score-badge { font-weight: bold; color: #333; }
        #debugStatus {
            font-size: 10px; color: #555; background: rgba(255,255,255,0.8);
            padding: 2px 8px; border-radius: 10px; margin-top: 5px;
        }

        /* KNAPP MANUELL POSISJON */
        .manual-pos-btn {
            position: absolute; top: 100px; right: 10px; z-index: 2000;
            background: white; padding: 12px; border-radius: 50%;
            border: none; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer;
        }
        .manual-pos-btn:disabled { opacity: 0.5; filter: grayscale(100%); }

        /* ROBOT */
        .robot-wrapper { position: fixed; bottom: 140px; right: 20px; z-index: 2000; display: flex; flex-direction: column; align-items: flex-end; pointer-events: none; }
        .robot-bubble { background: white; padding: 12px; border-radius: 15px 15px 0 15px; font-size: 13px; margin-bottom: 5px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); max-width: 180px; text-align: right; display: none; font-weight: bold; }
        .robot-body { font-size: 60px; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.3)); animation: bounce 3s infinite ease-in-out; cursor: pointer; pointer-events: auto; }
        @keyframes bounce { 0%, 100% {transform: translateY(0);} 50% {transform: translateY(-15px);} }

        /* KAMERA */
        #cameraPage { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: black; z-index: 6000; display: none; }
        #cameraPage.active { display: block; }
        #videoFeed { width: 100%; height: 100%; object-fit: cover; }
        #photoCanvas { display: none; }
        #capturedPhoto { position: absolute; top:0; left:0; width:100%; height:100%; object-fit: cover; display: none; z-index: 6001; }
        .camera-ui { position: absolute; bottom: 50px; width: 100%; display: flex; justify-content: center; z-index: 6005; padding-bottom: env(safe-area-inset-bottom); }
        .snap-btn { width: 80px; height: 80px; background: white; border-radius: 50%; border: 6px solid #ddd; cursor: pointer; }
        .save-btn { background: var(--primary); color: white; padding: 15px 40px; border-radius: 30px; border: none; font-size: 18px; font-weight: bold; display: none; cursor: pointer; }
        .close-cam { position: absolute; top: 20px; right: 20px; color: white; font-size: 35px; top: max(20px, env(safe-area-inset-top)); z-index: 7000; cursor: pointer; }

        /* LIGHTBOX */
        #imageModal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 8000; display: none; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        #imageModal.active { display: flex; }
        #fullImage { max-width: 100%; max-height: 50vh; border-radius: 10px; margin-bottom: 15px; }
        .modal-close { position: absolute; top: 30px; right: 30px; color: white; font-size: 40px; cursor: pointer; z-index: 8001; }
        .modal-controls { width: 100%; max-width: 300px; display: flex; flex-direction: column; gap: 10px; }
        .name-row { display: flex; gap: 10px; }
        #imgNameInput { flex: 1; padding: 12px; border-radius: 8px; border: none; font-size: 16px; outline: none; }
        .save-name-btn { background: #3498db; color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .delete-btn { background: #e74c3c; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 5px; }
        .cost-info { color: #ccc; font-size: 12px; text-align: center; margin-bottom: 5px; }
        #imgScoreDisplay { color: var(--primary); font-weight: 800; margin-bottom: 10px; font-size: 18px; }

        /* SIDER */
        .page { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #f0f2f5; z-index: 4000; display: none; flex-direction: column; overflow-y: auto; padding-bottom: 100px; }
        .page.active { display: flex; }

        /* --- PROFIL DESIGN (MATCHET MED BILDE 2/3) --- */
        .profile-header {
            background-color: var(--primary); /* Helgr√∏nn bakgrunn */
            padding: 40px 20px 20px;
            color: white;
            text-align: center;
            display: flex; flex-direction: column; align-items: center;
        }
        
        /* Avatar sirkel */
        .profile-avatar { 
            font-size: 50px; 
            background: #2c3e50; 
            color: white;
            width: 90px; height: 90px; 
            border-radius: 50%; 
            display: flex; justify-content: center; align-items: center; 
            border: 4px solid rgba(255,255,255,0.3); 
            margin-bottom: 10px;
        }
        
        .profile-name { font-size: 24px; font-weight: 700; cursor: pointer; }
        .profile-name span { border-bottom: 1px dashed rgba(255,255,255,0.5); }
        .profile-level { font-size: 14px; opacity: 0.9; margin-bottom: 20px; }

        /* Avatar Container (Den m√∏rkegr√∏nne stripen) */
        .avatar-container {
            background: rgba(0, 0, 0, 0.1); /* Transparent m√∏rk stripe */
            border-radius: 50px;
            padding: 8px 15px;
            display: flex; gap: 10px;
            margin-top: 10px;
            width: 90%; max-width: 400px;
            justify-content: center;
            overflow-x: auto; /* Scrolle hvis mange */
        }
        .avatar-option { 
            font-size: 22px; cursor: pointer; 
            width: 40px; height: 40px; 
            border-radius: 50%; 
            background: rgba(255,255,255,0.25); 
            display: flex; justify-content: center; align-items: center;
            transition: 0.2s;
            flex-shrink: 0;
        }
        .avatar-option.selected { 
            background: white; border: 2px solid #2c3e50; transform: scale(1.1); 
        }

        /* Hvit statistikk-bar (Som bilde 2) */
        .profile-stats {
            background: white;
            padding: 15px 0;
            display: flex; justify-content: space-around;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }
        .stat-box { text-align: center; width: 50%; }
        .stat-box:first-child { border-right: 1px solid #eee; }
        .stat-val { font-size: 20px; font-weight: 800; color: #333; }
        .stat-label { font-size: 10px; color: #7f8c8d; text-transform: uppercase; font-weight: bold; }

        .section-title { margin: 0 20px 15px; font-size: 16px; color: #333; font-weight: 800; }

        /* Galleri Grid */
        .gallery-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 0 20px; }
        .gallery-item { position: relative; cursor: pointer; border-radius: 12px; overflow: hidden; background: #ddd; aspect-ratio: 1; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .gallery-img { width: 100%; height: 100%; object-fit: cover; }
        .gallery-overlay { 
            position: absolute; bottom: 0; left: 0; right: 0; 
            background: rgba(0,0,0,0.6); color: white; 
            font-size: 11px; padding: 8px; text-align: center;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        /* MENY (Bunn - Hvit pille) */
        .bottom-nav {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; height: 70px;
            background: white; border-radius: 35px;
            display: flex; justify-content: space-around; align-items: center;
            z-index: 5000; box-shadow: 0 5px 25px rgba(0,0,0,0.1);
            padding: 0 10px;
        }
        .nav-item { background: none; border: none; display: flex; flex-direction: column; align-items: center; color: #ccc; width: 50px; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        .nav-icon { width: 24px; height: 24px; fill: currentColor; margin-bottom: 4px; }
        .nav-text { font-size: 9px; font-weight: bold; text-transform: uppercase; }
        
        .cam-btn-round {
            width: 70px; height: 70px; border-radius: 50%; 
            background: var(--primary); border: 5px solid white; 
            position: relative; top: -35px;
            display: flex; justify-content: center; align-items: center; 
            box-shadow: 0 -5px 15px rgba(0,0,0,0.1); cursor: pointer;
        }

        /* Leaderboard Style */
        .lb-list { padding: 20px; }
        .lb-item { display: flex; align-items: center; background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .lb-rank { width: 30px; font-weight: bold; color: #999; }
        .lb-avatar { width: 40px; height: 40px; border-radius: 50%; background: #eee; margin-right: 15px; display: flex; justify-content: center; align-items: center; font-size: 22px; }
        .lb-info { flex-grow: 1; }
        .lb-name { font-weight: bold; color: #333; font-size: 14px; }
        .lb-xp { font-size: 11px; color: #777; }
        .lb-score { font-weight: bold; color: var(--primary); }
        .lb-item.me { border: 2px solid var(--primary); background: #f0fdf4; }

        /* Butikk Style */
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 20px; }
        .shop-item { background: white; padding: 15px; border-radius: 15px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .buy-btn { background: var(--primary); color: white; border: none; width: 100%; padding: 10px; border-radius: 10px; margin-top: 10px; font-weight: bold; cursor: pointer; }

        .me-dot { width: 20px; height: 20px; background: #3498db; border: 4px solid white; border-radius: 50%; box-shadow: 0 0 15px rgba(52, 152, 219, 0.6); }
    </style>
</head>
<body>

    <div id="startScreen">
        <h1 style="color:var(--primary); font-size: 40px; margin-bottom: 5px;">EcoDex</h1>
        <p style="color:#7f8c8d;">Utforsk verden!</p>
        <button class="start-btn" onclick="initGame()">START üìç</button>
        <p style="font-size: 13px; margin-top: 30px; color: #999; max-width: 80%;">
            Tillat GPS. Trykk "Flytt Meg" for manuell posisjon (1 fors√∏k).
        </p>
    </div>

    <div id="map"></div>
    
    <button class="manual-pos-btn" id="btnManualPos" onclick="activateManualMode()" title="Flytt posisjon">üìç</button>

    <div class="top-hud">
        <div class="hud-bg">
            <div class="logo">ECODEX</div>
            <div class="score-badge">‚≠ê <span id="scoreVal">0</span></div>
        </div>
        <div id="debugStatus">Klar til start...</div>
    </div>

    <div class="robot-wrapper" onclick="robotTalk()">
        <div class="robot-bubble" id="robotMsg">Hei!</div>
        <div class="robot-body">ü§ñ</div>
    </div>

    <div id="cameraPage">
        <div class="close-cam" onclick="closeCamera()">‚úï</div>
        <video id="videoFeed" autoplay playsinline muted></video>
        <canvas id="photoCanvas"></canvas>
        <img id="capturedPhoto" src="">
        <div class="camera-ui">
            <button class="snap-btn" id="snapBtn" onclick="takePhoto()"></button>
            <button class="save-btn" id="saveBtn" onclick="savePhotoAndGetPoints()">LAGRE</button>
        </div>
    </div>

    <div id="imageModal">
        <div class="modal-close" onclick="closeImageModal()">‚úï</div>
        <img id="fullImage" src="" alt="Stort bilde">
        <div id="imgScoreDisplay">Verdi: 0 poeng</div>
        <div class="modal-controls">
            <div class="cost-info">Kj√∏p navneendring: -50 poeng</div>
            <div class="name-row">
                <input type="text" id="imgNameInput" placeholder="Nytt navn...">
                <button class="save-name-btn" onclick="saveImageName()">Kj√∏p</button>
            </div>
            <button class="delete-btn" onclick="deleteCurrentPhoto()">Slett Bilde üóëÔ∏è</button>
        </div>
    </div>

    <div id="shopPage" class="page">
        <h2 style="text-align: center; color: #333; padding: 20px;">Butikk</h2>
        <div id="shopList" class="shop-grid"></div>
    </div>
    
    <div id="profilePage" class="page" style="padding: 0;">
        <div class="profile-header">
            <div class="profile-avatar" id="currentAvatar">üë§</div>
            <div class="profile-name" onclick="editPlayerName()">
                <span id="playerNameDisplay">Meg (Deg)</span> ‚úé
            </div>
            <div class="profile-level">Niv√• <span id="levelVal">1</span></div>
            
            <div style="font-size:11px; opacity:0.8; margin-bottom:5px;">Velg Avatar:</div>
            <div class="avatar-container" id="avatarSelector">
                </div>
        </div>
        
        <div class="profile-stats">
            <div class="stat-box">
                <div class="stat-val" id="totalScoreVal">0</div>
                <div class="stat-label">POENG</div>
            </div>
            <div class="stat-box">
                <div class="stat-val" id="photoCountVal">0</div>
                <div class="stat-label">BILDER</div>
            </div>
        </div>
        
        <div class="section-title">Mitt Galleri</div>
        <div id="gallery" class="gallery-grid"></div>
        <p id="emptyMsg" style="text-align: center; color: #999; margin-top: 40px;">Ingen bilder tatt enda.</p>
    </div>
    
    <div id="leaderboardPage" class="page">
        <h2 style="text-align: center; color: #333; padding: 20px;">Toppliste</h2>
        <div class="lb-list" id="lbList"></div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" id="btnMap" onclick="showPage('map')">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M20.5 3l-6 2-6-2-6 2v15l6 2 6-2 6 2 2.5-0.8V4.2L20.5 3zM14 17.5l-6 2-6-2V5.5l6 2 6-2v12z"/></svg>
            <span class="nav-text">KART</span>
        </div>
        <div class="nav-item" id="btnShop" onclick="showPage('shop')">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/></svg>
            <span class="nav-text">BUTIKK</span>
        </div>
        <div class="cam-btn-round" onclick="openCamera()">
            <svg fill="white" width="32" height="32" viewBox="0 0 24 24"><path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm6 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5-5 5z"/></svg>
        </div>
        <div class="nav-item" id="btnProfile" onclick="showPage('profile')">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
            <span class="nav-text">PROFIL</span>
        </div>
        <div class="nav-item" id="btnLeaderboard" onclick="showPage('leaderboard')">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14h-2v-4h2v4zm-4 0H8v-8h2v8zm8 0h-2v-6h2v6z"/></svg>
            <span class="nav-text">TOPP</span>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map, playerMarker;
        let score = 0;
        let inventory = [];
        let photos = []; 
        let manualLocationMode = false;
        let manualPositionUsed = false; 
        let currentLat = 0, currentLng = 0;
        let currentViewingPhotoId = null;
        let playerAvatar = "üë§"; 
        let playerName = "Meg (Deg)";

        const avatars = ["üë§", "üë©", "üë®", "üßô", "üßö", "üßú", "ü¶ä", "ü§ñ"];

        const shopItems = [
            { id: 1, name: "Kompass", cost: 50, icon: "üß≠" },
            { id: 2, name: "Lys", cost: 100, icon: "üî¶" },
            { id: 3, name: "Hatt", cost: 150, icon: "üß¢" },
            { id: 4, name: "Sekk", cost: 300, icon: "üéí" },
            { id: 5, name: "Telt", cost: 400, icon: "‚õ∫" },
            { id: 6, name: "Drone", cost: 500, icon: "üöÅ" },
            { id: 7, name: "Kano", cost: 750, icon: "üõ∂" },
            { id: 8, name: "Pro Kamera", cost: 1000, icon: "üì∑" }
        ];

        const mockPlayers = [
            { name: "NaturVandrer", xp: 4520, avatar: "üßî" },
            { name: "Skogsmusa", xp: 3460, avatar: "üê≠" },
            { name: "Fjellreven", xp: 2800, avatar: "ü¶ä" }
        ];

        function initGame() {
            document.getElementById('startScreen').style.display = 'none';
            loadData();
            setupMap();
            updateStatus("S√∏ker...");
            map.locate({ setView: true, maxZoom: 18, timeout: 30000, enableHighAccuracy: true });
            startContinuousGPS();
            renderShop();
            setupAvatarSelector();
        }

        function startContinuousGPS() {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(
                    (pos) => {
                        currentLat = pos.coords.latitude;
                        currentLng = pos.coords.longitude;
                        if (!manualLocationMode && !manualPositionUsed) {
                            playerMarker.setLatLng([currentLat, currentLng]);
                            updateStatus("üìç GPS Aktiv");
                        }
                    },
                    (err) => console.warn(err), { enableHighAccuracy: true }
                );
            }
        }

        function updateStatus(msg) { document.getElementById('debugStatus').innerText = msg; }

        function setupMap() {
            map = L.map('map', { zoomControl: false }).setView([0, 0], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '', maxZoom: 19 }).addTo(map);
            const icon = L.divIcon({ className: 'p-icon', html: '<div class="me-dot"></div>', iconSize: [20, 20] });
            playerMarker = L.marker([0, 0], { icon: icon }).addTo(map);

            map.on('locationfound', (e) => {
                if(!manualLocationMode && !manualPositionUsed) {
                    currentLat = e.latlng.lat; currentLng = e.latlng.lng;
                    updateStatus("üìç GPS Funnet!");
                    playerMarker.setLatLng(e.latlng);
                    if (Math.random() > 0.8) spawnCreature(e.latlng.lat + 0.0005, e.latlng.lng + 0.0005);
                }
            });
            
            map.on('locationerror', () => { updateStatus("GPS feil. Bruk knappen."); });

            map.on('click', function (e) {
                if (manualLocationMode) {
                    currentLat = e.latlng.lat; currentLng = e.latlng.lng;
                    playerMarker.setLatLng(e.latlng); map.setView(e.latlng, 17);
                    updateStatus("Manuell posisjon satt");
                    spawnCreature(e.latlng.lat + 0.0003, e.latlng.lng + 0.0003);
                    manualLocationMode = false;
                    manualPositionUsed = true; 
                    const btn = document.getElementById('btnManualPos');
                    btn.disabled = true;
                    btn.style.opacity = "0.5";
                    robotTalk("Posisjon satt! (1 fors√∏k brukt)");
                }
            });
        }

        function activateManualMode() {
            if(manualPositionUsed) {
                robotTalk("Du har brukt opp fors√∏ket ditt!");
                return;
            }
            manualLocationMode = true;
            updateStatus("KLIKK P√Ö KARTET (1 fors√∏k)");
            robotTalk("Velg hvor du er. Du har 1 fors√∏k!");
        }

        function spawnCreature(lat, lng) {
            const icon = L.divIcon({ html: '<div style="font-size:35px">ü¶â</div>', className: 'c', iconSize: [35, 35] });
            L.marker([lat, lng], { icon: icon }).addTo(map).bindPopup("En ugle!");
            robotTalk("Jeg ser et dyr!");
        }

        function openCamera() {
            document.getElementById('cameraPage').classList.add('active');
            document.getElementById('capturedPhoto').style.display = 'none';
            document.getElementById('saveBtn').style.display = 'none';
            document.getElementById('saveBtn').innerText = "LAGRE";
            document.getElementById('snapBtn').style.display = 'block';
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(stream => { document.getElementById('videoFeed').srcObject = stream; })
                .catch(err => alert("Kamera Feil: " + err));
        }
        function closeCamera() {
            const vid = document.getElementById('videoFeed');
            if (vid.srcObject) vid.srcObject.getTracks().forEach(t => t.stop());
            document.getElementById('cameraPage').classList.remove('active');
        }
        function takePhoto() {
            const vid = document.getElementById('videoFeed');
            const can = document.getElementById('photoCanvas');
            const img = document.getElementById('capturedPhoto');
            can.width = vid.videoWidth; can.height = vid.videoHeight;
            can.getContext('2d').drawImage(vid, 0, 0);
            img.src = can.toDataURL('image/png'); img.style.display = 'block';
            document.getElementById('snapBtn').style.display = 'none';
            
            const potentialPoints = Math.floor(Math.random() * 201) + 50;
            const saveBtn = document.getElementById('saveBtn');
            saveBtn.style.display = 'block';
            saveBtn.innerText = `LAGRE (+${potentialPoints}p)`;
            saveBtn.dataset.points = potentialPoints;
        }
        function savePhotoAndGetPoints() {
            const saveBtn = document.getElementById('saveBtn');
            const pointsForThisPic = parseInt(saveBtn.dataset.points) || 100;
            score += pointsForThisPic;
            const newPhoto = { id: Date.now(), src: document.getElementById('capturedPhoto').src, name: "Uten navn", score: pointsForThisPic };
            photos.push(newPhoto);
            saveData(); updateScoreUI(); updateProfileUI(); renderGallery();
            robotTalk(`Bilde lagret! +${pointsForThisPic}p`);
            closeCamera();
        }

        function setupAvatarSelector() {
            const container = document.getElementById('avatarSelector');
            container.innerHTML = "";
            avatars.forEach(av => {
                const span = document.createElement('span');
                span.className = `avatar-option ${av === playerAvatar ? 'selected' : ''}`;
                span.innerText = av;
                span.onclick = () => {
                    playerAvatar = av;
                    document.getElementById('currentAvatar').innerText = av;
                    saveData();
                    setupAvatarSelector(); 
                };
                container.appendChild(span);
            });
            document.getElementById('currentAvatar').innerText = playerAvatar;
            document.getElementById('playerNameDisplay').innerText = playerName;
        }

        function editPlayerName() {
            const newName = prompt("Skriv inn nytt kallenavn:", playerName);
            if (newName && newName.trim() !== "") {
                playerName = newName.trim();
                document.getElementById('playerNameDisplay').innerText = playerName;
                saveData();
            }
        }

        function openImageModal(id) {
            const photo = photos.find(p => p.id === id);
            if (!photo) return;
            currentViewingPhotoId = id;
            document.getElementById('fullImage').src = photo.src;
            document.getElementById('imgScoreDisplay').innerText = `Verdi: ${photo.score} poeng`;
            document.getElementById('imgNameInput').value = photo.name === "Uten navn" ? "" : photo.name;
            document.getElementById('imageModal').classList.add('active');
        }
        function closeImageModal() {
            document.getElementById('imageModal').classList.remove('active');
            currentViewingPhotoId = null;
        }
        function saveImageName() {
            const cost = 50;
            const name = document.getElementById('imgNameInput').value;
            const photo = photos.find(p => p.id === currentViewingPhotoId);
            if (photo && name) {
                if (score >= cost) {
                    score -= cost; photo.name = name; saveData(); updateScoreUI(); renderGallery(); closeImageModal(); robotTalk("Navn kj√∏pt! (-50p)");
                } else { alert("Du trenger 50 poeng for √• endre navn!"); }
            }
        }
        function deleteCurrentPhoto() {
            if(currentViewingPhotoId && confirm("Slette bildet?")) {
                photos = photos.filter(p => p.id !== currentViewingPhotoId);
                saveData(); updateProfileUI(); renderGallery(); closeImageModal(); robotTalk("Bilde slettet.");
            }
        }

        function renderGallery() {
            const gallery = document.getElementById('gallery');
            gallery.innerHTML = "";
            if (photos.length === 0) { document.getElementById('emptyMsg').style.display = 'block'; return; }
            document.getElementById('emptyMsg').style.display = 'none';
            [...photos].reverse().forEach(p => {
                const div = document.createElement('div');
                div.className = 'gallery-item';
                div.onclick = function() { openImageModal(p.id); };
                div.innerHTML = `<img src="${p.src}" class="gallery-img"><div class="gallery-overlay">${p.name} <span class="gallery-score">(${p.score}p)</span></div>`;
                gallery.appendChild(div);
            });
        }

        function renderLeaderboard() {
            const list = document.getElementById('lbList');
            list.innerHTML = "";
            let sourceData = [...mockPlayers];
            sourceData.push({ name: playerName, xp: score, avatar: playerAvatar, isMe: true });
            sourceData.sort((a, b) => b.xp - a.xp);
            sourceData.forEach((p, index) => {
                const item = document.createElement('div');
                item.className = `lb-item ${p.isMe ? 'me' : ''}`;
                item.innerHTML = `<div class="lb-rank">${index + 1}</div><div class="lb-avatar">${p.avatar}</div><div class="lb-info"><div class="lb-name">${p.name}</div><div class="lb-xp">Level ${Math.floor(p.xp/1000)+1}</div></div><div class="lb-score">${p.xp}</div>`;
                list.appendChild(item);
            });
        }

        function loadData() {
            const s = localStorage.getItem('ecoDexScore');
            const i = localStorage.getItem('ecoDexInv');
            const p = localStorage.getItem('ecoDexPhotoObjects'); 
            const a = localStorage.getItem('ecoDexAvatar');
            const m = localStorage.getItem('ecoDexManualUsed');
            const n = localStorage.getItem('ecoDexPlayerName');
            if (s) score = parseInt(s);
            if (i) inventory = JSON.parse(i);
            if (p) photos = JSON.parse(p);
            if (a) playerAvatar = a;
            if (m) manualPositionUsed = (m === 'true');
            if (n) playerName = n;
            
            if(manualPositionUsed) {
                const btn = document.getElementById('btnManualPos');
                btn.disabled = true;
                btn.style.opacity = "0.5";
            }
            updateScoreUI(); updateProfileUI(); renderGallery();
        }
        function saveData() { 
            localStorage.setItem('ecoDexScore', score); 
            localStorage.setItem('ecoDexInv', JSON.stringify(inventory));
            localStorage.setItem('ecoDexPhotoObjects', JSON.stringify(photos));
            localStorage.setItem('ecoDexAvatar', playerAvatar);
            localStorage.setItem('ecoDexManualUsed', manualPositionUsed);
            localStorage.setItem('ecoDexPlayerName', playerName);
        }
        function updateScoreUI() { document.getElementById('scoreVal').innerText = score; }
        function updateProfileUI() {
            document.getElementById('totalScoreVal').innerText = score;
            document.getElementById('photoCountVal').innerText = photos.length;
        }
        
        function renderShop() {
            const g = document.getElementById('shopList'); g.innerHTML = "";
            shopItems.forEach(i => {
                const owned = inventory.includes(i.id);
                g.innerHTML += `<div class="shop-item"><div style="font-size:35px">${i.icon}</div><b>${i.name}</b><br><span style="color:#2ecc71">${i.cost} p</span><br><button class="buy-btn ${owned?'owned':''}" onclick="buyItem(${i.id},${i.cost})">${owned?'EID':'KJ√òP'}</button></div>`;
            });
        }
        function buyItem(id, cost) {
            if(inventory.includes(id)) return;
            if(score >= cost) { score -= cost; inventory.push(id); saveData(); updateScoreUI(); renderShop(); robotTalk("Kj√∏pt!"); } 
            else robotTalk("Mangler poeng!");
        }
        function robotTalk(msg) {
            const b = document.getElementById('robotMsg'); b.innerText = msg; b.style.display = 'block';
            setTimeout(() => b.style.display = 'none', 4000);
        }
        
        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            
            if (id === 'map') document.getElementById('btnMap').classList.add('active');
            else if (id === 'shop') document.getElementById('btnShop').classList.add('active');
            else if (id === 'profile') { document.getElementById('btnProfile').classList.add('active'); updateProfileUI(); }
            else if (id === 'leaderboard') { document.getElementById('btnLeaderboard').classList.add('active'); renderLeaderboard(); }
            
            if (id !== 'map') document.getElementById(id + 'Page').classList.add('active');
        }
    </script>
</body>
</html>