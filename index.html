<!DOCTYPE html>
<html lang="no">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>EcoDex</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/ml5@0.12.2/dist/ml5.min.js"></script>

    <style>
        :root {
            --primary: #27ae60;
            --bg-color: #f0f2f5;
            --text-color: #333;
            --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --chat-me: #2ecc71;
            --chat-them: #e5e5ea;
            --shop-gold: #f1c40f;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        body {
            margin: 0;
            background: var(--bg-color);
            font-family: var(--font);
            overflow: hidden;
            height: 100vh;
            height: 100dvh;
        }

        /* LOGIN */
        #loginScreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle, #2ecc71, #27ae60);
            z-index: 100000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 30px;
            color: white;
            transition: opacity 0.5s;
        }

        .login-box {
            background: white;
            padding: 30px;
            border-radius: 20px;
            width: 100%;
            max-width: 350px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .login-input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #eee;
            border-radius: 10px;
            font-size: 16px;
            outline: none;
            text-align: center;
            background: #f9f9f9;
            color: black;
        }

        .login-input:focus {
            border-color: var(--primary);
            background: white;
        }

        .login-btn {
            background: var(--primary);
            color: white;
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            transition: 0.2s;
        }

        .signup-btn {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            transition: 0.2s;
        }

        .signup-btn:active,
        .login-btn:active {
            transform: scale(0.98);
        }

        #loginError {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 15px;
            font-weight: bold;
            min-height: 20px;
        }

        /* LOADING */
        #aiLoading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            z-index: 9000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #ccc;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        /* KART & MARK√òRER */
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1;
        }

        .player-map-icon {
            text-align: center;
            line-height: 1;
            font-size: 40px;
            filter: drop-shadow(0 5px 5px rgba(0, 0, 0, 0.4));
            transition: all 0.3s ease;
        }

        .player-map-img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .marker-anim {
            animation: bounceMarker 2s infinite;
        }

        @keyframes bounceMarker {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        /* FOTO MARK√òR */
        .photo-marker-icon {
            width: 30px;
            height: 30px;
            background: #f1c40f;
            border: 3px solid white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 16px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.4);
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            0% { transform: scale(0); }
            100% { transform: scale(1); }
        }

        /* ANDRE SPILLERE */
        .custom-div-icon {
            background: transparent;
            border: none;
        }

        .other-player-icon {
            font-size: 30px;
            text-align: center;
            animation: float 3s infinite ease-in-out;
            filter: drop-shadow(0 2px 2px rgba(0, 0, 0, 0.3));
        }

        .other-player-label {
            background: rgba(255, 255, 255, 0.8);
            padding: 2px 5px;
            border-radius: 5px;
            font-size: 10px;
            font-weight: bold;
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        /* HUD */
        .top-hud {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 15px 20px;
            padding-top: max(15px, env(safe-area-inset-top));
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            pointer-events: none;
        }

        .hud-bg {
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 20px;
            border-radius: 30px;
            display: flex;
            gap: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .score-badge {
            font-weight: bold;
            color: #333;
        }

        #debugStatus {
            font-size: 10px;
            color: #555;
            background: rgba(255, 255, 255, 0.8);
            padding: 2px 8px;
            border-radius: 10px;
            margin-top: 5px;
        }

        /* ROBOT */
        .robot-wrapper {
            position: fixed;
            bottom: 120px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            pointer-events: none;
        }

        .robot-bubble {
            background: white;
            padding: 10px 15px;
            border-radius: 15px 15px 0 15px;
            font-size: 13px;
            margin-bottom: 5px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            max-width: 180px;
            text-align: right;
            display: none;
            font-weight: bold;
            color: #333;
        }

        .robot-body {
            width: 60px;
            filter: drop-shadow(0 5px 5px rgba(0, 0, 0, 0.3));
            animation: float 3s infinite ease-in-out;
            cursor: pointer;
            pointer-events: auto;
        }

        /* KAMERA */
        #cameraPage {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: black;
            z-index: 6000;
            display: none;
        }

        #cameraPage.active {
            display: block;
        }

        #videoFeed {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #photoCanvas {
            display: none;
        }

        #capturedPhoto {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
            z-index: 6001;
        }

        .camera-ui {
            position: absolute;
            bottom: 50px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            z-index: 6005;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .snap-btn {
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 50%;
            border: 6px solid #ddd;
            cursor: pointer;
        }

        .save-btn {
            background: var(--primary);
            color: white;
            padding: 15px 40px;
            border-radius: 30px;
            border: none;
            font-size: 18px;
            font-weight: bold;
            display: none;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .close-cam {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 35px;
            top: max(20px, env(safe-area-inset-top));
            z-index: 7000;
            cursor: pointer;
            text-shadow: 0 0 5px black;
        }

        #aiResultText {
            color: white;
            font-weight: bold;
            background: rgba(0, 0, 0, 0.6);
            padding: 10px 20px;
            border-radius: 20px;
            display: none;
            text-align: center;
            max-width: 80%;
        }

        /* CHAT */
        #chatOverlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 5000;
            display: none;
            flex-direction: column;
        }

        .chat-header {
            padding: 15px;
            background: var(--primary);
            color: white;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            padding-top: max(15px, env(safe-area-inset-top));
        }

        .chat-close {
            font-size: 30px;
            cursor: pointer;
            padding: 0 10px;
            line-height: 1;
        }

        .chat-header-avatar {
            font-size: 24px;
            background: rgba(255, 255, 255, 0.2);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: #f0f2f5;
        }

        .msg {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
            line-height: 1.4;
            position: relative;
        }

        .msg.me {
            align-self: flex-end;
            background: var(--chat-me);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .msg.them {
            align-self: flex-start;
            background: var(--chat-them);
            color: black;
            border-bottom-left-radius: 5px;
        }

        .typing-indicator {
            font-size: 10px;
            color: #777;
            margin-left: 10px;
            display: none;
            padding-bottom: 5px;
        }

        .chat-input-form {
            padding: 10px;
            background: white;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 10px;
            padding-bottom: max(10px, env(safe-area-inset-bottom));
        }

        .chat-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 25px;
            outline: none;
            font-size: 16px;
        }

        .chat-send {
            background: var(--primary);
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* SIDER & GRID */
        .page {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #f0f2f5;
            z-index: 4000;
            display: none;
            flex-direction: column;
            overflow-y: auto;
            padding-bottom: 110px;
        }

        .page.active {
            display: flex;
        }

        .section-title {
            margin: 20px 20px 10px;
            font-size: 16px;
            color: #333;
            font-weight: 800;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            padding: 0 20px;
        }

        .item-card {
            background: white;
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: 0.2s;
            position: relative;
        }

        .item-card:active {
            transform: scale(0.95);
        }

        .item-card.equipped {
            border: 3px solid var(--primary);
            background: #e8f8f5;
        }

        .item-icon {
            font-size: 40px;
            margin-bottom: 5px;
        }

        .item-name {
            font-size: 14px;
            font-weight: bold;
            color: #333;
        }

        .item-desc {
            font-size: 11px;
            color: #777;
            margin: 5px 0 10px;
            line-height: 1.2;
        }

        .item-cost {
            font-size: 12px;
            color: var(--primary);
            font-weight: bold;
            margin-top: 5px;
        }

        /* NY STIL FOR BUTIKK KNAPPER */
        .shop-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: 0.2s;
        }

        .shop-btn.owned {
            background: #2c3e50;
            color: #fff;
            cursor: default;
        }

        .shop-btn.disabled {
            background: #bdc3c7;
            color: #fff;
            cursor: not-allowed;
        }

        .shop-balance-card {
            background: linear-gradient(135deg, #f1c40f, #f39c12);
            color: white;
            margin: 20px 20px 10px;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 5px 15px rgba(241, 196, 15, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* SOSIALT */
        .tab-bar {
            display: flex;
            justify-content: space-around;
            background: white;
            padding: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .tab-btn {
            border: none;
            background: none;
            font-weight: bold;
            color: #999;
            font-size: 14px;
            padding: 10px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .search-row {
            display: flex;
            gap: 10px;
            padding: 0 20px 20px;
        }

        .search-input {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #ddd;
            font-size: 16px;
            outline: none;
        }

        .search-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 0 20px;
            font-weight: bold;
            cursor: pointer;
        }

        .lb-list {
            padding: 0 20px;
        }

        .lb-item {
            display: flex;
            align-items: center;
            background: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .lb-rank {
            width: 30px;
            font-weight: bold;
            color: #999;
        }

        .lb-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #eee;
            margin-right: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 22px;
        }

        .lb-info {
            flex-grow: 1;
        }

        .lb-name {
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .lb-score {
            font-weight: bold;
            color: var(--primary);
        }

        .lb-item.me {
            border: 2px solid var(--primary);
            background: #f0fdf4;
        }

        /* PROFIL */
        .profile-header {
            background-color: var(--primary);
            padding: 40px 20px 20px;
            color: white;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .profile-avatar-container {
            width: 120px;
            height: 120px;
            position: relative;
            margin-bottom: 15px;
        }

        .profile-avatar {
            font-size: 60px;
            background: #2c3e50;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 4px solid rgba(255, 255, 255, 0.3);
            overflow: hidden;
            color: white;
        }

        .custom-avatar-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .equipped-on-profile {
            position: absolute;
            bottom: -5px;
            right: -5px;
            font-size: 40px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
            z-index: 20;
        }

        .edit-avatar-btn {
            position: absolute;
            bottom: 0;
            right: 0;
            background: var(--primary);
            color: white;
            border: 3px solid white;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 30;
        }

        .settings-btn {
            margin-top: 10px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid white;
            padding: 8px 15px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
        }

        .profile-name-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            margin-top: 15px;
            cursor: pointer;
        }

        #avatarSelector {
            display: none;
            flex-direction: column;
            align-items: center;
            background: white;
            padding: 15px;
            border-radius: 15px;
            margin-top: 10px;
            width: 90%;
            max-width: 350px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        /* SETTINGS OVERLAY */
        #settingsOverlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 6000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .settings-box {
            background: white;
            width: 100%;
            max-width: 350px;
            border-radius: 20px;
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .settings-input-group label {
            display: block;
            font-size: 12px;
            font-weight: bold;
            color: #555;
            margin-bottom: 5px;
        }

        .settings-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .save-settings-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }

        #avatarSelector.show {
            display: flex;
        }

        .avatar-scroll {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 10px 0;
            width: 100%;
            margin-bottom: 10px;
        }

        .avatar-choice {
            font-size: 30px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            cursor: pointer;
            flex-shrink: 0;
            color: #333;
            border: 1px solid #eee;
        }

        .avatar-choice.selected {
            background: #e8f8f5;
            border: 2px solid var(--primary);
        }

        .upload-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* MENY */
        .bottom-nav {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 92%;
            max-width: 400px;
            height: 65px;
            background: white;
            border-radius: 35px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 4500;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.15);
            padding: 0 10px;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #ccc;
            cursor: pointer;
            width: 50px;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-icon {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        .cam-btn-round {
            width: 65px;
            height: 65px;
            border-radius: 50%;
            background: var(--primary);
            border: 5px solid white;
            position: relative;
            top: -30px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.1);
            cursor: pointer;
        }
    </style>
</head>

<body>

    <div id="loginScreen">
        <div style="font-size: 40px; font-weight:900; margin-bottom:20px;">ECODEX</div>
        <div class="login-box">
            <h2 style="color:#333; margin:0; margin-bottom: 20px;">Velkommen</h2>
            <input type="email" id="emailInput" class="login-input" placeholder="E-postadresse">
            <input type="password" id="passwordInput" class="login-input" placeholder="Passord">
            <div id="loginError"></div>

            <button class="login-btn" onclick="loginUser()">LOGG INN</button>
            <button class="signup-btn" onclick="registerUser()">NY BRUKER</button>
        </div>
        <p style="font-size:11px; margin-top:20px; opacity:0.8; max-width: 250px; text-align: center;">
            Logg inn hvis du har konto, eller trykk Ny Bruker for √• lage en.
        </p>
    </div>

    <div id="aiLoading">
        <div class="spinner"></div>
        <p style="margin-top:20px; font-weight:bold; color:#555;">Kobler til hjernen...</p>
    </div>

    <div id="map"></div>

    <div class="top-hud">
        <div class="hud-bg">
            <div style="font-weight:900; color:var(--primary);">ECODEX</div>
            <div class="score-badge">‚≠ê <span id="scoreVal">0</span> XP</div>
        </div>
        <div id="debugStatus">S√∏ker posisjon...</div>
    </div>

    <div class="robot-wrapper" onclick="showRobotTip()">
        <div class="robot-bubble" id="robotMsg">Trykk p√• meg for tips!</div>
        <img src="https://cdn-icons-png.flaticon.com/512/4712/4712109.png" class="robot-body" alt="Bot"
            onerror="this.src='https://cdn-icons-png.flaticon.com/512/4712/4712109.png'">
    </div>

    <div id="cameraPage">
        <div class="close-cam" onclick="closeCamera()">‚úï</div>
        <video id="videoFeed" autoplay playsinline muted></video>
        <canvas id="photoCanvas"></canvas>
        <img id="capturedPhoto" src="">
        <div class="camera-ui">
            <div id="aiResultText">Analyserer...</div>
            <button class="snap-btn" id="snapBtn" onclick="takePhoto()"></button>
            <button class="save-btn" id="saveBtn" onclick="savePhoto()">LAGRE BILDE</button>
        </div>
    </div>

    <div id="chatOverlay">
        <div class="chat-header">
            <div class="chat-close" onclick="closeChat()">‚ùÆ</div>
            <div class="chat-header-avatar" id="chatHeaderAvatar">üë§</div>
            <div id="chatNameTitle">Navn</div>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="typing-indicator" id="typingIndicator">Skriver...</div>

        <form class="chat-input-form" onsubmit="handleChatSubmit(event)">
            <input type="text" class="chat-input" id="chatInput" placeholder="Skriv en melding..." autocomplete="off">
            <button type="submit" class="chat-send">‚û§</button>
        </form>
    </div>

    <div id="settingsOverlay">
        <div class="settings-box">
            <div class="settings-header">
                <h2 style="margin:0; font-size:20px;">Innstillinger</h2>
                <div style="font-size:24px; cursor:pointer;" onclick="closeSettings()">‚úï</div>
            </div>

            <div class="settings-input-group">
                <label>Brukernavn</label>
                <input type="text" id="settingUsername" class="settings-input">
            </div>

            <div class="settings-input-group">
                <label>E-post</label>
                <input type="email" id="settingEmail" class="settings-input">
            </div>

            <div class="settings-input-group">
                <label>Nytt Passord</label>
                <input type="password" id="settingPassword" class="settings-input"
                    placeholder="La st√• tomt for √• beholde">
            </div>

            <button class="save-settings-btn" onclick="saveSettings()">Lagre Endringer</button>
        </div>
    </div>

    <div id="shopPage" class="page">
        <div class="shop-balance-card">
            <div>
                <div style="font-size:12px; opacity:0.9;">DIN SALDO</div>
                <div style="font-size:24px; font-weight:900;" id="shopBalanceDisplay">0 XP</div>
            </div>
            <div style="font-size:30px;">üí∞</div>
        </div>

        <h2 class="section-title">Utstyr</h2>
        <div id="shopList" class="grid-container"></div>
    </div>

    <div id="socialPage" class="page">
        <div class="tab-bar">
            <button class="tab-btn active" onclick="switchSocialTab('friends')" id="tabFriends">VENNER</button>
            <button class="tab-btn" onclick="switchSocialTab('add')" id="tabAdd">LEGG TIL</button>
            <button class="tab-btn" onclick="switchSocialTab('leaderboard')" id="tabLeaderboard">TOPPLISTE</button>
        </div>

        <div id="viewFriends">
            <h2 class="section-title">Mine Venner (Chat her)</h2>
            <div id="friendList" class="grid-container"></div>
        </div>

        <div id="viewAdd" style="display:none;">
            <h2 class="section-title">S√∏k etter personer</h2>
            <div class="search-row">
                <input type="text" id="searchFriendInput" class="search-input" placeholder="Navn (f.eks. Mamma)...">
                <button class="search-btn" onclick="searchFriends()">S√òK</button>
            </div>
            <div id="addFriendList" class="grid-container"></div>
        </div>

        <div id="viewLeaderboard" style="display:none;">
            <h2 class="section-title">Toppliste (Global)</h2>
            <div id="leaderboardList" class="lb-list"></div>
        </div>
    </div>

    <div id="profilePage" class="page" style="padding: 0;">
        <div class="profile-header">
            <div class="profile-avatar-container">
                <div class="profile-avatar" id="profileAvatarDisplay">üë§</div>
                <div class="equipped-on-profile" id="profileItemDisplay"></div>
                <div class="edit-avatar-btn" onclick="toggleAvatarMenu()">‚úé</div>
            </div>

            <div class="profile-name-container">
                <div class="profile-name" id="profileNameDisplay" style="font-weight:800; font-size:24px;">Gjest</div>
                <div style="font-size:12px; opacity:0.8; margin-top:5px;">Niv√•: <span id="profileLevelDisplay">1</span></div>
            </div>

            <button class="settings-btn" onclick="openSettings()">‚öôÔ∏è Innstillinger</button>

            <div id="avatarSelector">
                <p style="font-size:12px; color:#777; margin-bottom:5px;">Velg emoji eller last opp bilde:</p>
                <div class="avatar-scroll" id="emojiList"></div>
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">üì∑ Last opp
                    bilde</button>
                <input type="file" id="fileInput" accept="image/*" style="display: none;"
                    onchange="handleFileUpload(this)">
            </div>

            <button class="logout-btn" onclick="logout()">Logg ut</button>
        </div>

        <h2 class="section-title">Ryggsekk</h2>
        <div id="inventoryList" class="grid-container"></div>

        <h2 class="section-title">Mine Funn</h2>
        <div id="gallery" class="grid-container"></div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" id="btnMap" onclick="showPage('map')">
            <svg class="nav-icon" viewBox="0 0 24 24">
                <path d="M20.5 3l-6 2-6-2-6 2v15l6 2 6-2 6 2 2.5-0.8V4.2L20.5 3zM14 17.5l-6 2-6-2V5.5l6 2 6-2v12z" />
            </svg>
            <span style="font-size:9px; font-weight:bold;">KART</span>
        </div>
        <div class="nav-item" id="btnShop" onclick="showPage('shop')">
            <svg class="nav-icon" viewBox="0 0 24 24">
                <path
                    d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z" />
            </svg>
            <span style="font-size:9px; font-weight:bold;">BUTIKK</span>
        </div>
        <div class="cam-btn-round" onclick="openCamera()">
            <svg fill="white" width="32" height="32" viewBox="0 0 24 24">
                <path
                    d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm6 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5-5 5z" />
            </svg>
        </div>
        <div class="nav-item" id="btnSocial" onclick="showPage('social')">
            <svg class="nav-icon" viewBox="0 0 24 24">
                <path
                    d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z" />
            </svg>
            <span style="font-size:9px; font-weight:bold;">SOSIALT</span>
        </div>
        <div class="nav-item" id="btnProfile" onclick="showPage('profile')">
            <svg class="nav-icon" viewBox="0 0 24 24">
                <path
                    d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
            </svg>
            <span style="font-size:9px; font-weight:bold;">PROFIL</span>
        </div>
    </div>

    <script>
        const defaultState = {
            score: 0,
            avatar: "üë§",
            inventory: [],
            equipped: null,
            photos: [],
            friends: ["Tod Erik (AI)"],
            chats: {}
        };

        let state = { ...defaultState, username: "Gjest" };

        const avatars = ["üë§", "üë©", "üë®", "üßù", "üßö", "üßô", "üßõ", "üßü", "üßú", "ü¶ä", "üêª", "ü§ñ"];

        // OPPDATERT UTSTYRS-LISTE MED BESKRIVELSER
        const items = [
            { id: 1, name: "Kompass", cost: 50, icon: "üß≠", desc: "Finn veien hjem." },
            { id: 2, name: "Lommelykt", cost: 100, icon: "üî¶", desc: "Se bedre i m√∏rket." },
            { id: 3, name: "Caps", cost: 150, icon: "üß¢", desc: "Beskytt deg mot solen." },
            { id: 4, name: "Sekk", cost: 300, icon: "üéí", desc: "B√¶r mer utstyr." },
            { id: 5, name: "Kikkert", cost: 400, icon: "üî≠", desc: "Se dyr p√• lang avstand." },
            { id: 6, name: "Kano", cost: 1000, icon: "üõ∂", desc: "Utforsk vannet." }
        ];

        // START DATABASE MED FALSKE BRUKERE
        const fakeUsers = [
            { name: "NaturVandrer", score: 540, avatar: "üßî" },
            { name: "Skogsmusa", score: 890, avatar: "üê≠" },
            { name: "FjellReven", score: 1200, avatar: "ü¶ä" },
            { name: "ByFuglen", score: 320, avatar: "üê¶" },
            { name: "TurLederen", score: 2100, avatar: "üë©‚Äçüåæ" },
            { name: "Tod Erik (AI)", score: 9999, avatar: "ü§ñ" },
            { name: "Lars", score: 450, avatar: "üë®" },
            { name: "Lisa", score: 670, avatar: "üë©" }
        ];

        const robotTips = [
            "Husk √• se etter sopp i skyggen!",
            "Blekkspruter har tre hjerter!",
            "Mos kan vise vei mot nord.",
            "Haier er eldre enn tr√¶r!",
            "Ta bilde av en blomst for poeng!",
            "Kuer har bestevenner.",
            "Skyer er tunge som bly!",
            "G√• til Sosialt-menyen for √• chatte med meg."
        ];

        let map, playerMarker, photoLayer, fakeUsersLayer, classifier;
        let currentLat = 0, currentLng = 0;
        let aiModelLoaded = false;
        let currentChatPartner = null;

        window.onload = function () {
            const lastUser = localStorage.getItem('ecoDexLastUser');
            if (lastUser) {
                const allUsers = JSON.parse(localStorage.getItem('ecoDexUsers') || '{}');
                if (allUsers[lastUser]) {
                    state = allUsers[lastUser];
                    document.getElementById('loginScreen').style.display = 'none';
                    startAIAndGame();
                    return;
                }
            }
        };

        function loginUser() {
            const email = document.getElementById('emailInput').value.trim();
            const pass = document.getElementById('passwordInput').value.trim();
            const errDiv = document.getElementById('loginError');

            if (!email || !pass) { errDiv.innerText = "Mangler e-post eller passord."; return; }

            const userKey = email.toLowerCase();
            let allUsers = JSON.parse(localStorage.getItem('ecoDexUsers') || '{}');

            if (allUsers[userKey]) {
                if (allUsers[userKey].password === pass) {
                    state = allUsers[userKey];
                    finishLogin(userKey);
                } else {
                    errDiv.innerText = "Feil passord.";
                }
            } else {
                errDiv.innerText = "Bruker finnes ikke. Trykk NY BRUKER.";
            }
        }

        function registerUser() {
            const email = document.getElementById('emailInput').value.trim();
            const pass = document.getElementById('passwordInput').value.trim();
            const errDiv = document.getElementById('loginError');

            if (!email || !pass) { errDiv.innerText = "Mangler e-post eller passord."; return; }
            if (!email.includes('@')) { errDiv.innerText = "Ugyldig e-post."; return; }

            const userKey = email.toLowerCase();
            let allUsers = JSON.parse(localStorage.getItem('ecoDexUsers') || '{}');

            if (allUsers[userKey]) {
                errDiv.innerText = "Bruker finnes allerede. Trykk LOGG INN.";
            } else {
                const username = email.split('@')[0];
                state = { ...defaultState, username: username, email: email, password: pass };
                allUsers[userKey] = state;
                localStorage.setItem('ecoDexUsers', JSON.stringify(allUsers));
                finishLogin(userKey);
            }
        }

        function finishLogin(userKey) {
            localStorage.setItem('ecoDexLastUser', userKey);
            const loginScr = document.getElementById('loginScreen');
            loginScr.style.opacity = '0';
            setTimeout(() => { loginScr.style.display = 'none'; }, 500);
            startAIAndGame();
        }

        function logout() {
            if (confirm("Logge ut?")) {
                localStorage.removeItem('ecoDexLastUser');
                location.reload();
            }
        }

        function startAIAndGame() {
            document.getElementById('aiLoading').style.display = 'flex';
            classifier = ml5.imageClassifier('MobileNet', () => {
                aiModelLoaded = true;
                document.getElementById('aiLoading').style.display = 'none';
                initGame();
            });
        }

        function initGame() {
            setupMap();
            setupUI();
            robotTalk(`Velkommen, ${state.username}!`);
            startGPS();

            if ('wakeLock' in navigator) {
                navigator.wakeLock.request('screen').catch(err => console.log(err));
            }
        }

        function startGPS() {
            if (navigator.geolocation) {
                const options = { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 };
                navigator.geolocation.watchPosition(pos => {
                    currentLat = pos.coords.latitude;
                    currentLng = pos.coords.longitude;
                    const latlng = [currentLat, currentLng];

                    if (playerMarker) playerMarker.setLatLng(latlng);
                    else updatePlayerMarker();

                    document.getElementById('debugStatus').innerText = "GPS Aktiv ‚úÖ";

                    generateFakeUsersMap();
                }, err => {
                    document.getElementById('debugStatus').innerText = "GPS Feil ‚ùå. G√• ut.";
                }, options);
            } else {
                alert("Din enhet st√∏tter ikke GPS.");
            }
        }

        function setupMap() {
            if (map) return;
            map = L.map('map', { zoomControl: false }).setView([59.91, 10.75], 16);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

            photoLayer = L.layerGroup().addTo(map);
            fakeUsersLayer = L.layerGroup().addTo(map);

            updatePlayerMarker();
            renderMapPhotos();
        }

        function renderMapPhotos() {
            if (!photoLayer || !map) return;
            
            photoLayer.clearLayers();

            if (state.photos && state.photos.length > 0) {
                state.photos.forEach(p => {
                    if (p.lat && p.lng) {
                        
                        const icon = L.divIcon({
                            className: 'photo-marker-icon',
                            html: 'üì∑',
                            iconSize: [30, 30],
                            iconAnchor: [15, 15],
                            popupAnchor: [0, -15]
                        });

                        const marker = L.marker([p.lat, p.lng], { icon: icon });
                        
                        const popupContent = `
                            <div style="text-align:center;">
                                <img src="${p.src}" style="width:120px; height:80px; object-fit:cover; border-radius:8px; border:2px solid #27ae60;">
                                <br>
                                <b style="color:#333;">${p.label}</b>
                                <br>
                                <span style="color:#27ae60; font-weight:bold;">+${p.points} poeng</span>
                            </div>
                        `;
                        
                        marker.bindPopup(popupContent);
                        photoLayer.addLayer(marker);
                    }
                });
            }
        }

        function generateFakeUsersMap() {
            if (!fakeUsersLayer || currentLat === 0) return;
            fakeUsersLayer.clearLayers();

            const seededRandom = (seed) => {
                const x = Math.sin(seed++) * 10000;
                return x - Math.floor(x);
            }
            const timeSeed = Math.floor(Date.now() / 5000);

            fakeUsers.slice(0, 3).forEach((user, index) => {
                const latOffset = (seededRandom(timeSeed + index) - 0.5) * 0.002;
                const lngOffset = (seededRandom(timeSeed + index + 100) - 0.5) * 0.002;

                const userLat = currentLat + latOffset;
                const userLng = currentLng + lngOffset;

                const iconHtml = `<div class="other-player-icon">${user.avatar}</div>
                                  <div class="other-player-label">${user.name}</div>`;

                const icon = L.divIcon({
                    className: 'custom-div-icon',
                    html: iconHtml,
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                });

                const marker = L.marker([userLat, userLng], { icon: icon });
                marker.bindPopup(`<b>${user.name}</b><br>Niv√•: ${Math.floor(user.score / 100)}`);
                fakeUsersLayer.addLayer(marker);
            });
        }

        function getPlayerIconHTML() {
            let itemIcon = "";
            if (state.equipped) {
                const item = items.find(i => i.id === state.equipped);
                if (item) itemIcon = item.icon;
            }

            let avatarHTML = "";
            if (state.avatar.startsWith('data:image')) {
                avatarHTML = `<img src="${state.avatar}" class="player-map-img">`;
            } else {
                avatarHTML = `<div style="font-size:40px;">${state.avatar}</div>`;
            }

            return `<div class="marker-anim" style="position:relative;">
                        ${avatarHTML}
                        <div style="position:absolute; bottom:-5px; right:-5px; font-size:25px; z-index:10;">${itemIcon}</div>
                    </div>`;
        }

        function updatePlayerMarker() {
            if (!map) return;
            const html = getPlayerIconHTML();
            const icon = L.divIcon({ className: 'player-map-icon', html: html, iconSize: [50, 50] });
            if (playerMarker) playerMarker.setIcon(icon);
            else playerMarker = L.marker([currentLat || 59.91, currentLng || 10.75], { icon: icon }).addTo(map);
        }

        /* --- KAMERA & LAGRING --- */
        function openCamera() {
            document.getElementById('cameraPage').classList.add('active');
            document.getElementById('snapBtn').style.display = 'block';
            document.getElementById('saveBtn').style.display = 'none';
            document.getElementById('capturedPhoto').style.display = 'none';
            document.getElementById('aiResultText').style.display = 'none';
            const constraints = { video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } } };
            navigator.mediaDevices.getUserMedia(constraints)
                .then(stream => { document.getElementById('videoFeed').srcObject = stream; })
                .catch(err => alert("Kamerafeil: " + err));
        }

        function closeCamera() {
            const vid = document.getElementById('videoFeed');
            if (vid.srcObject) vid.srcObject.getTracks().forEach(t => t.stop());
            document.getElementById('cameraPage').classList.remove('active');
        }

        function takePhoto() {
            const vid = document.getElementById('videoFeed');
            const can = document.getElementById('photoCanvas');
            const img = document.getElementById('capturedPhoto');

            const maxWidth = 600;
            const scale = maxWidth / vid.videoWidth;
            const width = maxWidth;
            const height = vid.videoHeight * scale;

            can.width = width;
            can.height = height;
            can.getContext('2d').drawImage(vid, 0, 0, width, height);

            img.src = can.toDataURL('image/jpeg', 0.7);

            img.style.display = 'block';
            document.getElementById('snapBtn').style.display = 'none';
            document.getElementById('aiResultText').innerText = "Analyserer bilde...";
            document.getElementById('aiResultText').style.display = 'block';

            const safetyTimeout = setTimeout(() => {
                showResult("Naturfunn?", 50);
            }, 3000);

            if (aiModelLoaded) {
                classifier.classify(img, (err, results) => {
                    clearTimeout(safetyTimeout);
                    if (err) showResult("Ukjent objekt", 10);
                    else processAIResults(results);
                });
            } else {
                clearTimeout(safetyTimeout);
                showResult("AI ikke klar", 10);
            }
        }

        function processAIResults(results) {
            const topResult = results[0].label;
            let points = 20;
            let msg = `Jeg ser: ${topResult}`;
            const natureWords = ["bird", "flower", "tree", "plant", "dog", "cat", "animal", "insect", "fish", "grass", "leaf", "mushroom", "sea"];
            const rareWords = ["eagle", "bear", "wolf", "orchid", "fox"];
            const lowerLabel = topResult.toLowerCase();
            if (rareWords.some(w => lowerLabel.includes(w))) { points = 500; msg += " (SJELDEN! ‚≠ê)"; }
            else if (natureWords.some(w => lowerLabel.includes(w))) { points = 150; msg += " (Naturfunn! üåø)"; }
            else { points = 10; msg += " (Ikke s√• mye natur?)"; }
            showResult(msg, points);
        }

        function showResult(text, pts) {
            const ui = document.getElementById('aiResultText');
            ui.innerText = text;
            const btn = document.getElementById('saveBtn');
            btn.innerText = `LAGRE (+${pts} poeng)`;
            btn.dataset.points = pts;
            btn.dataset.label = text;
            btn.style.display = 'block';
        }

        function savePhoto() {
            const pts = parseInt(document.getElementById('saveBtn').dataset.points);
            const label = document.getElementById('saveBtn').dataset.label;
            state.score += pts;

            let photoLat = currentLat;
            let photoLng = currentLng;
            if (photoLat === 0 && photoLng === 0) {
                photoLat = 59.91;
                photoLng = 10.75;
                console.log("Ingen GPS, bruker test-lokasjon");
            }

            if (!Array.isArray(state.photos)) state.photos = [];

            state.photos.push({
                src: document.getElementById('capturedPhoto').src,
                label: label,
                points: pts,
                lat: photoLat,
                lng: photoLng
            });

            try {
                let allUsers = JSON.parse(localStorage.getItem('ecoDexUsers') || '{}');
                const userKey = state.email || state.username;
                allUsers[userKey] = state;
                localStorage.setItem('ecoDexUsers', JSON.stringify(allUsers));

                closeCamera();
                showPage('map');
                
                setTimeout(() => {
                    map.invalidateSize();
                    renderMapPhotos();
                    renderGallery();
                    updateUI();
                    map.flyTo([photoLat, photoLng], 18, { animate: true, duration: 1.5 });
                    robotTalk(`Bilde lagret! +${pts} XP`);
                }, 100);

            } catch (e) {
                alert("Lagring fullt! Du m√• slette noen bilder.");
            }
        }

        function showRobotTip() {
            const randomTip = robotTips[Math.floor(Math.random() * robotTips.length)];
            robotTalk(randomTip);
        }

        /* --- CHAT --- */
        function openChat(name) {
            currentChatPartner = name;
            document.getElementById('chatNameTitle').innerText = name;
            const u = fakeUsers.find(fu => fu.name === name) || { avatar: "üë§" };
            document.getElementById('chatHeaderAvatar').innerText = u.avatar;
            document.getElementById('chatOverlay').style.display = 'flex';
            renderMessages();
        }

        function closeChat() {
            document.getElementById('chatOverlay').style.display = 'none';
            currentChatPartner = null;
        }

        function renderMessages() {
            const container = document.getElementById('chatMessages');
            container.innerHTML = "";
            const history = state.chats[currentChatPartner] || [];

            if (history.length === 0) {
                container.innerHTML = `<div style="text-align:center; color:#999; font-size:12px; margin-top:20px;">Start samtalen med ${currentChatPartner}!</div>`;
            }

            history.forEach(msg => {
                const div = document.createElement('div');
                div.className = `msg ${msg.sender}`;
                div.innerText = msg.text;
                container.appendChild(div);
            });
            container.scrollTop = container.scrollHeight;
        }

        function getBotResponse(text) {
            text = text.toLowerCase();
            if (text.includes("hei") || text.includes("hallo")) return "Hei der! Klar for √• utforske naturen?";
            if (text.includes("hvem")) return "Jeg er Tod Erik, din virtuelle guide i EcoDex!";
            if (text.includes("hva")) return "Jeg kan hjelpe deg med √• identifisere ting, eller bare prate.";
            if (text.includes("poeng")) return "Du f√•r poeng ved √• ta bilder av dyr og planter.";
            if (text.includes("butikk")) return "I butikken kan du kj√∏pe utstyr for poengene dine.";
            if (text.includes("kjedelig")) return "G√• ut en tur! Naturen er aldri kjedelig hvis du ser n√∏ye etter.";
            if (text.includes("takk")) return "Bare hyggelig!";
            return "Interessant! Jeg l√¶rer fortsatt om verden.";
        }

        function getFriendResponse(text) {
            const t = text.toLowerCase();
            if (t.includes("hei")) return "Hei p√• deg! üëã";
            if (t.includes("skjer")) return "Jeg er ute og ser etter dyr! ü¶ä";
            if (t.includes("hvor")) return "Jeg er i skogen ved elva.";
            if (t.includes("kult") || t.includes("wow")) return "Ja, ikke sant?";
            if (t.includes("bilde")) return "Har du tatt noen fine bilder i dag? üì∏";
            return "Spennende! Vi m√• spille sammen snart.";
        }

        function handleChatSubmit(e) {
            e.preventDefault();
            sendMessage();
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();

            if (!text) return;
            if (!currentChatPartner) return alert("Feil: Ingen chat partner.");

            if (!state.chats[currentChatPartner]) state.chats[currentChatPartner] = [];
            state.chats[currentChatPartner].push({ sender: 'me', text: text });

            input.value = "";
            input.focus();
            renderMessages();
            
            try {
                let allUsers = JSON.parse(localStorage.getItem('ecoDexUsers') || '{}');
                const userKey = state.email || state.username;
                allUsers[userKey] = state;
                localStorage.setItem('ecoDexUsers', JSON.stringify(allUsers));
            } catch (e) { console.warn("Lagring feilet", e); }

            document.getElementById('typingIndicator').style.display = 'block';

            setTimeout(() => {
                let reply;
                if (currentChatPartner.includes("Tod Erik")) {
                    reply = getBotResponse(text);
                } else {
                    reply = getFriendResponse(text);
                }

                state.chats[currentChatPartner].push({ sender: 'them', text: reply });

                if (currentChatPartner && document.getElementById('chatOverlay').style.display !== 'none') {
                    document.getElementById('typingIndicator').style.display = 'none';
                    renderMessages();
                }
                try {
                    let allUsers = JSON.parse(localStorage.getItem('ecoDexUsers') || '{}');
                    const userKey = state.email || state.username;
                    allUsers[userKey] = state;
                    localStorage.setItem('ecoDexUsers', JSON.stringify(allUsers));
                } catch (e) { console.warn("Lagring feilet", e); }
            }, 1000);
        }

        // --- FORBEDRET BUTIKK LOGIKK ---
        function renderShop() {
            const div = document.getElementById('shopList');
            const balanceDisplay = document.getElementById('shopBalanceDisplay');
            
            div.innerHTML = "";
            balanceDisplay.innerText = state.score + " XP";

            items.forEach(item => {
                const owned = state.inventory.includes(item.id);
                const affordable = state.score >= item.cost;
                
                let btnClass = "shop-btn";
                let btnText = `KJ√òP (${item.cost})`;
                let onclickAction = `buyItem(${item.id}, ${item.cost})`;

                if (owned) {
                    btnClass += " owned";
                    btnText = "EIER ALLEREDE";
                    onclickAction = "";
                } else if (!affordable) {
                    btnClass += " disabled";
                }

                div.innerHTML += `
                <div class="item-card" onclick="${affordable && !owned ? onclickAction : ''}">
                    <div class="item-icon">${item.icon}</div>
                    <div class="item-name">${item.name}</div>
                    <div class="item-desc">${item.desc}</div>
                    <button class="${btnClass}">${btnText}</button>
                </div>`;
            });
        }

        function buyItem(id, cost) {
            if (state.inventory.includes(id)) return;
            if (state.score >= cost) {
                state.score -= cost;
                state.inventory.push(id);

                let allUsers = JSON.parse(localStorage.getItem('ecoDexUsers') || '{}');
                const userKey = state.email || state.username;
                allUsers[userKey] = state;
                localStorage.setItem('ecoDexUsers', JSON.stringify(allUsers));

                updateUI();
                renderShop();
                renderInventory();
                robotTalk("Kj√∏pt! Sjekk ryggsekken din.");
            } else {
                // Skal ikke skje pga disabled knapp, men greit √• ha
                robotTalk("Du har ikke nok poeng!");
            }
        }

        function renderInventory() {
            const div = document.getElementById('inventoryList');
            div.innerHTML = "";
            if (state.inventory.length === 0) div.innerHTML = "<p style='grid-column:span 3; text-align:center; color:#999;'>Tomt her...</p>";

            state.inventory.forEach(id => {
                const item = items.find(i => i.id === id);
                const isEquipped = state.equipped === id;
                div.innerHTML += `
                <div class="item-card ${isEquipped ? 'equipped' : ''}" onclick="equipItem(${id})">
                    <div class="item-icon">${item.icon}</div>
                    <div class="item-name">${item.name}</div>
                    <div class="item-cost">${isEquipped ? 'P√Ö' : 'BRUK'}</div>
                </div>`;
            });
        }

        function equipItem(id) {
            if (state.equipped === id) state.equipped = null;
            else state.equipped = id;

            let allUsers = JSON.parse(localStorage.getItem('ecoDexUsers') || '{}');
            const userKey = state.email || state.username;
            allUsers[userKey] = state;
            localStorage.setItem('ecoDexUsers', JSON.stringify(allUsers));

            renderInventory();
            updateUI();
            updatePlayerMarker();
        }

        function toggleAvatarMenu() {
            const menu = document.getElementById('avatarSelector');
            if (menu.classList.contains('show')) {
                menu.classList.remove('show');
            } else {
                menu.classList.add('show');
                if (document.getElementById('emojiList').innerHTML === "") setupEmojiList();
            }
        }

        function setupEmojiList() {
            const avDiv = document.getElementById('emojiList');
            avDiv.innerHTML = "";
            avatars.forEach(av => {
                const s = document.createElement('div');
                s.className = `avatar-choice ${av === state.avatar ? 'selected' : ''}`;
                s.innerText = av;
                s.onclick = () => {
                    state.avatar = av;

                    let allUsers = JSON.parse(localStorage.getItem('ecoDexUsers') || '{}');
                    const userKey = state.email || state.username;
                    allUsers[userKey] = state;
                    localStorage.setItem('ecoDexUsers', JSON.stringify(allUsers));

                    updateUI();
                    updatePlayerMarker();
                    toggleAvatarMenu();
                };
                avDiv.appendChild(s);
            });
        }

        function handleFileUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    state.avatar = e.target.result;

                    let allUsers = JSON.parse(localStorage.getItem('ecoDexUsers') || '{}');
                    const userKey = state.email || state.username;
                    allUsers[userKey] = state;
                    localStorage.setItem('ecoDexUsers', JSON.stringify(allUsers));

                    updateUI();
                    updatePlayerMarker();
                    toggleAvatarMenu();
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function setupUI() {
            renderShop();
            renderInventory();
            renderGallery();
            updateUI();
        }

        function updateUI() {
            document.getElementById('scoreVal').innerText = state.score;
            document.getElementById('profileNameDisplay').innerText = state.username;
            
            // Enkel niv√• beregning: 100 poeng per niv√•
            const level = Math.floor((state.score + (state.inventory.length * 50)) / 100) + 1;
            document.getElementById('profileLevelDisplay').innerText = level;

            const avatarContainer = document.getElementById('profileAvatarDisplay');
            if (state.avatar.startsWith('data:image')) {
                avatarContainer.innerHTML = `<img src="${state.avatar}" class="custom-avatar-img">`;
                avatarContainer.style.background = "none";
                avatarContainer.style.border = "none";
            } else {
                avatarContainer.innerHTML = state.avatar;
                avatarContainer.style.background = "#2c3e50";
                avatarContainer.style.border = "4px solid rgba(255,255,255,0.3)";
            }

            let icon = "";
            if (state.equipped) {
                const i = items.find(x => x.id === state.equipped);
                if (i) icon = i.icon;
            }
            document.getElementById('profileItemDisplay').innerText = icon;
        }

        function renderGallery() {
            const div = document.getElementById('gallery');
            div.innerHTML = "";
            if (state.photos) {
                [...state.photos].reverse().forEach(p => {
                    div.innerHTML += `
                    <div class="item-card" style="padding:0; overflow:hidden;">
                        <img src="${p.src}" style="width:100%; height:100px; object-fit:cover;">
                        <div style="font-size:10px; padding:5px;">${p.label}<br><b>${p.points}p</b></div>
                    </div>`;
                });
            }
        }

        function robotTalk(msg) {
            const b = document.getElementById('robotMsg');
            b.innerText = msg;
            b.style.display = 'block';
            setTimeout(() => b.style.display = 'none', 5000);
        }

        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if (id !== 'map') document.getElementById(id + 'Page').classList.add('active');

            if (id === 'map') {
                document.getElementById('btnMap').classList.add('active');
                setTimeout(() => map.invalidateSize(), 100);
            }
            if (id === 'social') document.getElementById('btnSocial').classList.add('active');
            if (id === 'shop') {
                document.getElementById('btnShop').classList.add('active');
                renderShop(); // Oppdater butikken hver gang vi √•pner den for √• vise riktig saldo
            }
            if (id === 'profile') document.getElementById('btnProfile').classList.add('active');

            if (id === 'social') switchSocialTab('friends');
        }

        function searchFriends() {
            const query = document.getElementById('searchFriendInput').value.trim();
            if (!query) {
                const nonFriends = fakeUsers.filter(u => !state.friends.includes(u.name));
                renderAddFriends(nonFriends);
                return;
            }
            const lowerQuery = query.toLowerCase();
            const results = fakeUsers.filter(u => u.name.toLowerCase().includes(lowerQuery));
            renderAddFriends(results, query);
        }

        function renderAddFriends(listToRender, query = "") {
            const list = document.getElementById('addFriendList');
            list.innerHTML = "";

            listToRender.forEach(u => {
                const isFriend = state.friends.includes(u.name);
                if (!isFriend) {
                    list.innerHTML += `
                    <div class="item-card" onclick="addFriend('${u.name}')">
                        <div class="item-icon">${u.avatar}</div>
                        <div class="item-name">${u.name}</div>
                        <div class="item-cost" style="color:var(--primary)">LEGG TIL +</div>
                    </div>`;
                }
            });

            if (listToRender.length === 0 && query) {
                list.innerHTML = `
                <div class="item-card" onclick="addCustomFriend('${query}')">
                    <div class="item-icon">‚ú®</div>
                    <div class="item-name">${query}</div>
                    <div class="item-cost" style="color:var(--primary)">OPPRETT & LEGG TIL</div>
                </div>`;
            } else if (list.innerHTML === "") {
                list.innerHTML = "<p style='width:200%; text-align:center; color:#999'>Alle foresl√•tte venner er lagt til!</p>";
            }
        }

        function addCustomFriend(name) {
            name = name.charAt(0).toUpperCase() + name.slice(1);
            const randomAvatars = ["ü¶∏", "ü¶π", "üßô‚Äç‚ôÇÔ∏è", "üßõ‚Äç‚ôÄÔ∏è", "üßû", "üßú‚Äç‚ôÇÔ∏è", "üëΩ", "üëæ"];
            const rAvatar = randomAvatars[Math.floor(Math.random() * randomAvatars.length)];

            fakeUsers.push({ name: name, score: 0, avatar: rAvatar });
            addFriend(name);
            document.getElementById('searchFriendInput').value = "";
            switchSocialTab('friends');
        }

        function addFriend(name) {
            if (!state.friends.includes(name)) {
                state.friends.push(name);
                let allUsers = JSON.parse(localStorage.getItem('ecoDexUsers') || '{}');
                const userKey = state.email || state.username;
                allUsers[userKey] = state;
                localStorage.setItem('ecoDexUsers', JSON.stringify(allUsers));
                searchFriends();
                robotTalk(`${name} er n√• din venn!`);
            }
        }

        function renderFriends() {
            const list = document.getElementById('friendList');
            list.innerHTML = "";
            if (state.friends.length === 0) list.innerHTML = "<p style='width:200%; text-align:center; color:#999'>Ingen venner enda.</p>";

            state.friends.forEach(fname => {
                const u = fakeUsers.find(fu => fu.name === fname) || { avatar: "üë§", name: fname };
                list.innerHTML += `
                <div class="item-card" onclick="openChat('${u.name}')">
                    <div class="item-icon">${u.avatar}</div>
                    <div class="item-name">${u.name}</div>
                    <div class="item-cost">CHAT üí¨</div>
                </div>`;
            });
        }

        function renderLeaderboard() {
            const list = document.getElementById('leaderboardList');
            list.innerHTML = "";
            let all = [...fakeUsers];
            all.push({ name: state.username, score: state.score, avatar: state.avatar, isMe: true });
            all.sort((a, b) => b.score - a.score);
            all.forEach((u, i) => {
                list.innerHTML += `
                <div class="lb-item ${u.isMe ? 'me' : ''}">
                    <div class="lb-rank">${i + 1}</div>
                    <div class="lb-avatar">${u.avatar}</div>
                    <div class="lb-info"><div class="lb-name">${u.name}</div></div>
                    <div class="lb-score">${u.score}p</div>
                </div>`;
            });
        }

        function switchSocialTab(tab) {
            document.getElementById('viewFriends').style.display = 'none';
            document.getElementById('viewAdd').style.display = 'none';
            document.getElementById('viewLeaderboard').style.display = 'none';
            document.getElementById('tabFriends').classList.remove('active');
            document.getElementById('tabAdd').classList.remove('active');
            document.getElementById('tabLeaderboard').classList.remove('active');

            if (tab === 'friends') {
                document.getElementById('viewFriends').style.display = 'block';
                document.getElementById('tabFriends').classList.add('active');
                renderFriends();
            } else if (tab === 'add') {
                document.getElementById('viewAdd').style.display = 'block';
                document.getElementById('tabAdd').classList.add('active');
                renderAddFriends(fakeUsers.slice(0, 4));
            } else {
                document.getElementById('viewLeaderboard').style.display = 'block';
                document.getElementById('tabLeaderboard').classList.add('active');
                renderLeaderboard();
            }
        }

        function openSettings() {
            document.getElementById('settingsOverlay').style.display = 'flex';
            document.getElementById('settingUsername').value = state.username || "";
            document.getElementById('settingEmail').value = state.email || "";
            document.getElementById('settingPassword').value = "";
        }

        function closeSettings() {
            document.getElementById('settingsOverlay').style.display = 'none';
        }

        function saveSettings() {
            const newUsername = document.getElementById('settingUsername').value.trim();
            const newEmail = document.getElementById('settingEmail').value.trim();
            const newPassword = document.getElementById('settingPassword').value.trim();

            if (!newUsername || !newEmail) {
                alert("Brukernavn og E-post kan ikke v√¶re tomme.");
                return;
            }

            const oldKey = state.email.toLowerCase();
            let allUsers = JSON.parse(localStorage.getItem('ecoDexUsers') || '{}');

            if (newEmail.toLowerCase() !== oldKey && allUsers[newEmail.toLowerCase()]) {
                alert("Denne e-postadressen er allerede i bruk.");
                return;
            }

            state.username = newUsername;

            if (newEmail.toLowerCase() !== oldKey) {
                state.email = newEmail;
                delete allUsers[oldKey];
                localStorage.setItem('ecoDexLastUser', newEmail.toLowerCase());
            }

            if (newPassword) {
                state.password = newPassword;
            }

            allUsers[state.email.toLowerCase()] = state;
            localStorage.setItem('ecoDexUsers', JSON.stringify(allUsers));

            updateUI();
            closeSettings();
            robotTalk("Innstilinger lagret!");
        }
    </script>
</body>

</html>